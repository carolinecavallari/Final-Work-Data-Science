install.packages("shinydashboard")

##Defining shiny dashboard components and publishing
```{r}
library(shinydashboard)
library(shiny)

ui <- fluidPage(
  titlePanel("COVID School Closures Dashboard"),
  # fluidRow(
  #   column(3,
  #   )
  #   ),
  sidebarLayout(
    sidebarPanel(
      helpText("sidebar panel"),
      
      selectInput("month_select", label = "Select the Month",
          choices = c("02-2020","03-2020","04-2020",
                      "05-2020","06-2020","07-2020",
                      "08-2020","09-2020","10-2020",
                      "11-2020","12-2020","01-2021",
                      "02-2021","03-2021","04-2021",
                      "05-2021","06-2021","07-2021",
                      "08-2021","09-2021","10-2021",
                      "11-2021"),
          selected = "02-2020"),
    ),
    mainPanel(plotlyOutput("fig"))
  ))



server <- function(input, output) {
  output$fig <- renderPlotly({
   
  filteredData <- filter(closures_df, month_year == input$month_select)
  
  fig <- plot_ly(filteredData, 
         type='choropleth', 
         locations= ~ISO, 
         z=closures_test$test, 
         text=closures_test$Country,
         colorscale=colorScale,
  colorbar=list(tickvals=1:nfactor, ticktext=names(foo))
  )
  
  fig
   })
}

shinyApp(ui, server)

```

## Dataframes
```{r}
library(tidyverse)
library(readr)
library(lubridate)
library(RColorBrewer)
closures_df <- read_csv("covid_impact_education.csv")

view(closures_df)

# Creating a month_year column
sf <- stamp("02-2019", orders = "my") 

closures_df$Date <- lubridate::dmy(closures_df$Date)

closures_df <- closures_df %>%
  mutate(month_year = sf(Date))

# Factoring Status
is.factor(closures_df$Status)
table(closures_df$Status)
closures_df$Status <- factor(closures_df$Status, levels = c("Closed due to COVID-19", "Partially open", "Fully open", "Academic break"))

closures_df$test <- as.numeric(closures_df$Status)

nfactor <- length(levels(closures_df$Status))
foo <- brewer.pal(n = nfactor, name = "Set1")
names(foo) <- levels(closures_df$Status)

total_month_year <- closures_df %>%
  group_by(Country) %>%
  unique(month_year)

```

## Plots
```{r}
library(ggplot2)
library(ggpubr)
library(plotly)
library("devtools")

install_github("ropensci/plotly")

py <- plotly(username="rAPI", key="yu680v5eii", base_url="https://plot.ly")

source("plotlyGraphWidget.R")


#Output Graph Function
graphOutput <- function(inputId, width="100%", height="550px") {
    tagList(
        singleton(tags$head(
            tags$script(src="plotlyGraphWidget.js")
        )),
       tags$iframe(id=inputId, src="https://plot.ly/~playground/7.embed",
       class="graphs", style="border:none;", seamless=TRUE, width=width, height=height)
    )
}

renderGraph <- function(expr, env=parent.frame(), quoted=FALSE) {
    ## This gets called when inputs change --
    ## Place data wrangling code in here
    ## and pass the result to the client
    ## to be graphed.


	installExprFunction(expr, "func", env, quoted)

    function(){
        data = func();
        ## data is the state of the widgets: see server.R
        ## this function returns a list of named lists that descripe
        ## valid postMessage commands to be sent to the embedded iframe.
        ## see binding.renderValue for the receiving JS side of this function
        ## and https://github.com/plotly/Embed-API for more about the postMessage
        ## graph messages
        return(data)

    }
}

# # light grey boundaries
# l <- list(color = toRGB("grey"), width = 0.5)
# 
# # specify map projection/options
# g <- list(
#   showframe = FALSE,
#   showcoastlines = FALSE,
#   projection = list(type = 'Mercator')
# )

closures_test <- closures_df %>%
  dplyr::filter(month_year == "11-2020")

Z_Breaks = function(n){
CUTS = seq(0,1,length.out=n+1)
rep(CUTS,ifelse(CUTS %in% 0:1,1,2))
}

colorScale <- data.frame(z=Z_Breaks(nfactor),
        col=rep(foo,each=2),stringsAsFactors=FALSE)


fig <- plot_ly(closures_test, 
               type='choropleth', 
               locations= ~ISO, 
               z=closures_test$test, 
               text=closures_test$Country,
               colorscale=colorScale,
  colorbar=list(tickvals=1:nfactor, ticktext=names(foo))
)

fig %>%
  layout(autosize = F, width = 750, height = 250)






```
