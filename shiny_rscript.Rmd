
##Defining shiny dashboard components and publishing
```{r}
ui <- dashboardPage(
    dashboardHeader(
      title = "School Closures during the Covid-19 Pandemic",
      titleWidth = 450),
    
    dashboardSidebar(
        sidebarMenu(
            menuItem("World Map and Scatterplot",
                     tabName = "plots_tab",
                     icon = icon("dashboard")),
            menuItem("By Country Table",
                     tabName = "table_tab",
                     icon = icon("th-list")),
            menuItem("Use Guide",
                     tabName = "guide_tab",
                     icon = icon("road"))
        )
    ),
    
    dashboardBody(
        tabItems(
            tabItem(tabName = "plots_tab",
                  fluidRow(box(span(h2("School Closure Totals"),
                  textOutput("date"),
                  textOutput("n_schools_closed"),
                  textOutput("n_schools_partial"),
                  textOutput("n_schools_open"),
                  textOutput("n_schools_break"),
             ))),
                  fluidRow(box(width = 12, selectInput(
                      "month_select",
                      label = "Select the Month to show on the Map",
                      choices = c(
                        "03-2020",
                        "04-2020",
                        "05-2020",
                        "06-2020",
                        "07-2020",
                        "08-2020",
                        "09-2020",
                        "10-2020",
                        "11-2020",
                        "12-2020",
                        "01-2021",
                        "02-2021",
                        "03-2021",
                        "04-2021",
                        "05-2021",
                        "06-2021",
                        "07-2021",
                        "08-2021",
                        "09-2021",
                        "10-2021",
                        "11-2021"
                      ),
                      selected = "11-2021"
                    ),
                    plotlyOutput("fig", width = "100%"))),
                  fluidRow(box(width = 12,
                    plotlyOutput("plot2", width = "100%"),
                    selectInput(
                      "region",
                      label = "Select the Region for the ScatterPlot",
                      choices = c(
                        "all",
                        "East Asia and Pacific",
                        "Eastern and Southern Africa",
                        "Eastern Europe and Central Asia",
                        "Latin America and Caribbean",
                        "Middle East and North Africa",
                        "North America ",
                        "South Asia",
                        "West and Central Africa",
                        "Western Europe"
                      ),
                      selected = "all"
                    ))
                    )),
            tabItem(tabName = "table_tab",
                    DT::dataTableOutput("closures_table")),
            tabItem(tabName = "guide_tab",
                    uiOutput("guide"))
        )
    ))
    
server <- function(input, output) {
  output$fig <- renderPlotly({
   
  filteredData <- filter(closures_df, month_year == input$month_select)
  
  colorScale <- data.frame(z=Z_Breaks(nfactor),
        col=rep(foo,each=2),stringsAsFactors=FALSE)
  
  fig <- plot_ly(filteredData, 
         type='choropleth', 
         locations= ~ISO, 
         z=filteredData$test, 
         text=filteredData$Country,
         colorscale=colorScale,
  colorbar=list(tickvals=1:nfactor, ticktext=names(foo))
  )
  
  fig
   })

  output$plot2 <- renderPlotly({
  
  region_data <- if(input$region != "all"){
    filter(complete_schools_df, region == input$region)
  } else {
    complete_schools_df
  }
    
  plot2 <- ggplot(region_data,
       aes(x = internet_access,
           y = fully_closed, 
           size = total_students,
           color = vac_priority_status,
            text = paste0(
          "<b>", country, "</b><br>",
          "Vacciation Group: ", vac_priority_status, "<br>",
          "Connectivity: ", scales::percent(region_data$internet_access, 1)
        )
           )) +
geom_point(show.legend = c(size = F)) +
    geom_text(aes(label = country), nudge_y = -0.25, nudge_x = 100, show.legend = T, check_overlap = T) +
  coord_cartesian(xlim = c(0.0, 1.0)) +
  labs(title = "A Brief Overview of Education Inequality during the Covid-19 Pandemic",
       x = "Connectivity rates per country",
       y = "Days of school's full closure", 
       color = "Teacher Priorization in Vaccination") +
        theme_minimal() +
    theme(panel.grid = element_line(linetype = 2)) +
        guides(size = FALSE)
  
  
  ggplotly(plot2, tooltip = "text", height = 400)
})
  
    output$closures_table <- DT::renderDataTable(closures_table_df,
                                        options = list(scrollX = TRUE),
                                        rownames = FALSE)
    
    output$date <- renderText({
      paste("On ", input$month_select)
    })
    
    output$n_schools_closed <- renderText({
      filteredClosed <- filter(closures_df, 
                               month_year == input$month_select & 
                                Status == "Closed due to COVID-19")
  
      paste("Countries with schools closed: ", length(unique(filteredClosed$Country)))
    })
      
    output$n_schools_partial <- renderText({
      filteredPartial <- filter(closures_df, 
                               month_year == input$month_select & 
                                Status == "Partially open")
      
      paste("Countries with schools partially closed: ",
            length(unique(filteredPartial$Country)))
    })
    
    output$n_schools_open <- renderText({
      filteredOpen <- filter(closures_df, 
                               month_year == input$month_select & 
                                Status == "Fully open")
      
      paste("Countries with schools fully open: ", length(unique(filteredOpen$Country)))
    })
    
    output$n_schools_break <- renderText({
      filteredBreak <- filter(closures_df, 
                               month_year == input$month_select & 
                                Status == "Academic break")
      
      paste("Countries on academic break: ", length(unique(filteredBreak$Country)))
    })
    
    output$guide <- renderUI({
      paste("Welcome to our dashboard!")
      rawText <- readLines("Guide.txt")
     splitText <- stringi::stri_split(str = rawText, regex = '\n')
      replacedText <- lapply(splitText, p)
      return(replacedText)
    })
  
}
shinyApp(ui, server)
```

